<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="js/qqv28.js"></script>
  <script type="module" src="js/console.js"></script>
</head>
<body>
 <script type="module">
import { m, butonsEditPanel, bottomPanel } 
from 'https://slachinov.github.io/Lib/pan/main.js';


import { saveFile, loadFile, getAllKeys } 
from 'https://slachinov.github.io/Lib/pan/idb.js';


let edit = m.edit;




function createIndexedDBPanel () {


  let container = qq.ce({
    tag: 'div',
    parent: m.topPanel,
    style: { margin: '1px 0', background: '#e0f7ff' }
  });


  // input key
  let keyInput = qq.ce({
    tag: 'input',
    parent: container,
    attr: { type: 'text', placeholder: 'Введите ключ IndexedDB' },
    style: { marginRight: '5px' }
  });


  // ===== Load =====
  qq.ce({
    tag: 'button',
    it: 'Load3',
    parent: container,
    style: { margin: '5px' },
    event: {
      click: async function () {
        let key = keyInput.value.trim();
        if (!key) return;


        try {
          let value = await loadFile(key);
          edit.innerText = value ?? '';
          if (value == null) qq.cl(`Нет значения в IndexedDB: "${key}"`);
        } catch (e) {
          qq.er(e);
        }
      }
    }
  });alert(78);


  // ===== Save =====
qq.ce({
    tag: 'button',
    it: 'Save',
    parent: container,
    style: {
      margin: mr,
      'font-size': `${fs}px`,
      background: 'red',
      color: 'white'
    }});


  /*qq.ce({
    tag: 'button',
    it: 'Save',
    parent: container,
    style: {
      margin: mr,
      'font-size': `${fs}px`,
      background: 'red',
      color: 'white'
    },
    event: {
      click: async function () {
        let key = keyInput.value.trim();
        if (!key) return;


        try {
          await saveFile(key, edit.innerText);
          qq.cl(`Сохранено в IndexedDB: "${key}"`);
        } catch (e) {
          qq.er(e);
        }
      }
    }
  });*/alert(8);


  // ===== All =====
  qq.ce({
    tag: 'button',
    it: 'All',
    parent: container,
    style: { margin: mr, 'font-size': `${fs}px` },
    event: {
      click: async function () {
        m.all.innerHTML = '';
        m.all.show();


        try {
          let keys = await getAllKeys();


          for (let key of keys) {
            qq.ce({
              tag: 'div',
              parent: m.all,
              it: key,
              style: {
                cursor: 'pointer',
                padding: '2px 4px',
                border: '1px solid gray',
                margin: '2px 0',
                borderRadius: '3px'
              },
              event: {
                click: async function () {
                  keyInput.value = key;
                  edit.innerText = await loadFile(key);
                  m.all.hide();
                }
              }
            });
          }


        } catch (e) {
          qq.er(e);
        }
      }
    }
  });


  return container;
};


createIndexedDBPanel ()
</script>
<script type="module">
import { saveFile, loadFile, getAllKeys } from 'https://slachinov.github.io/Lib/pan/idb.js';
qq.cl(990);
getAllKeys().then(keys => qq.cl(keys));
//==
(async () => {
  const keys = await getAllKeys();


  if (!keys.length) {
    qq.cl('IndexedDB пуст');
    return;
  }


  const items = [];


  for (let key of keys) {
    const value = await loadFile(key); // берём содержимое
    const size = new Blob([value]).size; // размер в байтах
    items.push({ key, size });
  }


  // Сортируем по размеру (от большего к меньшему)
  items.sort((a, b) => b.size - a.size);


  // Выводим через qq.cl
  items.forEach((item, index) => {
    qq.cl(`${index + 1}. "${item.key}" — ${item.size} байт`);
  });


  qq.cl(`✅ Всего элементов: ${items.length}`);
})();
</script>
<script type="module">


import {m,butonsEditPanel,bottomPanel} from 'https://slachinov.github.io/Lib/pan/main.js';


let edit = m.edit;//alert(m.all);


// === глобальные настройки для кнопок ===
let mr = '5px';
let fs = 20;


// === кнопка EVAL ===
qq.ce({
  tag: 'button',
  it: 'EVAL',
  style: { margin: mr, 'font-size': `${fs}px` },
  parent: butonsEditPanel,
  event: { click: function() { eval(edit.innerText); } }
});


// === кнопка CLEAR ===
qq.ce({
  tag: 'button',
  it: 'CLEAR',
  style: { margin: mr, 'font-size': `${fs}px` },
  parent: butonsEditPanel,
  event: { click: function() { edit.innerText = ''; } }
});
//====/


function toggleEditHtml(edit) {
  if (!edit._mode) edit._mode = 'text';


  if (edit._mode === 'text') {
    // TEXT → HTML
    edit._textCache = edit.innerText;
    edit.innerHTML = edit.innerText;
    edit.contentEditable = false;
    edit.style.background = '#e6d3b1'; // светло-коричневый
    edit._mode = 'html';
  } else {
    // HTML → TEXT
    edit.innerText = edit.innerHTML;
    edit.contentEditable = true;
    edit.style.background = 'lightgreen';
    edit._mode = 'text';
  }
}
// === кнопка PROBEL ===
qq.ce({
  tag: 'button',
  it: 'PRO4',
  style: { margin: mr, 'font-size': `${fs}px` },
  parent: butonsEditPanel,
  event: { click: function() { 
    toggleEditHtml(edit)
  } }
});


// === новая кнопка locSt в bottomPanel ===
qq.ce({
  tag: 'button',
  it: 'locSt',
  style: { margin: mr, 'font-size': `${fs}px` },
  parent: bottomPanel,
  event: { click: function() { 
    createLocalStoragePanel();
  } }
});
//==
function createLocalStoragePanel () {
  // создаём контейнер в topPanel
  let container = qq.ce({
    tag: 'div',
    parent: m.topPanel,
    style: { margin: '1px 0',
background:'#ffe4e1'}
  });


  // создаём инпут для ключа
  let keyInput = qq.ce({
    tag: 'input',
    parent: container,
    attr: { type: 'text', placeholder: 'Введите ключ localStorage' },
    style: { marginRight: '5px' }
  });


  // создаём кнопку Load
  qq.ce({
    tag: 'button',
    it: 'Load',
    style: { margin: '5px' },
    parent: container,
    event: {
      click: function() {
        let key = keyInput.value.trim();
        if (!key) return;
        let value = localStorage.getItem(key);
        edit.innerText = value !== null ? value : '';
        if (value === null) qq.cl(`Нет значения в localStorage по ключу: "${key}"`);
      }
    }
  });
//==
// === кнопка Save в topPanel ===
qq.ce({
  tag: 'button',
  it: 'Save',
  style: { 
    margin: mr, 
    'font-size': `${fs}px`, 
    background: 'red', 
    color: 'white' 
  },
  parent: container,
  event: {
    click: function() {
      let key = keyInput.value.trim();
      if (!key) return;
      localStorage.setItem(key, edit.innerText);
      qq.cl(`Сохранено: "${key}"`);
    }
  }
});


// === кнопка All в topPanel ===
qq.ce({
  tag: 'button',
  it: 'All',
  style: { margin: mr, 'font-size': `${fs}px` },
  parent: container,
  event: {
    click: function() {
      m.all.innerHTML = ''; // очищаем панель
      m.all.show();         // показываем панель


      for (let i = 0; i < localStorage.length; i++) {
        let key = localStorage.key(i);
        let value = localStorage.getItem(key);


        qq.ce({
          tag: 'div',
          parent: m.all,
          it: key,  // только ключ
          style: {
            cursor: 'pointer',
            padding: '2px 4px',
            border: '1px solid gray',
            margin: '2px 0',
            borderRadius: '3px'
          },
          event: {
            click: function() {
              keyInput.value = key;    // ключ в инпут
              edit.innerText = value;  // значение в edit
              m.all.hide();            // скрываем панель после выбора
            }
          }
        });
      }
    }
  }
});
//==
  return container;
}


// === 
//==
</script>
</body>
</html>